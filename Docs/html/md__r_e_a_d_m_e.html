<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RT2 Assignment: Research Track Final Assignment</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">RT2 Assignment
   &#160;<span id="projectnumber">1.0.3</span>
   </div>
   <div id="projectbrief">ROS Package for RT2 Assignment</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Research Track Final Assignment </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This repository contains the result of my personal work for the final Assignment of the course.</p>
<p>The goal of this assignment is to Develop a software architecture for the control of the robot in the environment. The software relies on the move_base and gmapping packages for localizing the robot and plan the motion. The architecture should be able to get the user request, and let the robot execute one of the following behaviors (depending on the userâ€™s input):</p>
<ol type="1">
<li>autonomously reach a x,y coordinate inserted by the user.</li>
<li>let the user drive the robot with the keyboard</li>
<li>let the user drive the robot assisting them to avoid collisions</li>
<li>autonomously cancel a goal if it is not reachable using a timeout</li>
<li>in addition we could add the functionality of manually canceling a given goal</li>
</ol>
<p>To do this we had to use ROS for controlling the robot and Gazebo and RViz environments. I decided to use C++ as programming language.</p>
<h1><a class="anchor" id="autotoc_md0"></a>
Table of contents</h1>
<ul>
<li><a href="#setup">Setup</a></li>
<li><a href="#gazebo-and-rviz-maps">Gazebo and Rviz Maps</a></li>
<li><a href="#project-structure-and-behaviour-description">Project structure and behaviour description</a></li>
<li><a href="#pseudocode">PseudoCode</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md1"></a>
Setup</h1>
<p>This repository Contains all the useful files to run the scripts that i produced for this assignment. To try it, it is sufficient to clone this repository in your ROS workspace:</p>
<div class="fragment"><div class="line">$ git clone https://github.com/claudio-dg/final_assignment.git</div>
</div><!-- fragment --><p>and then type the following command in the terminal to simultaneously launch all the necessary nodes through the **"launchFile"**:</p>
<div class="fragment"><div class="line">$ roslaunch final_assignment final.launch</div>
</div><!-- fragment --><p>This Launch File has been made to make it easier to run the project , but if you like you can manually run every part of the project by launching the following launch files:</p>
<div class="fragment"><div class="line">$ roslaunch final_assignment move_base.launch</div>
<div class="line">$ roslaunch final_assignment simulation_gmapping.launch</div>
</div><!-- fragment --><p>To run the simulation environment and the move_base functions.</p>
<div class="fragment"><div class="line">$ roslaunch final_assignment teleop.launch</div>
<div class="line">$ roslaunch final_assignment my_scripts.launch</div>
</div><!-- fragment --><p>To run the teleop_Twist_keyboard node and my scripts produced for this assignment.</p>
<h1><a class="anchor" id="autotoc_md2"></a>
Gazebo and Rviz Maps</h1>
<p>The environment used for this assignment consists in the map illustrated (froma Gazebo view) in the following image:</p>
<p><img src="https://github.com/claudio-dg/final_assignment/blob/main/images/Gazebo.png?raw=true" alt="" width="450" class="inline"/> </p>
<p>Rviz instead gives another point of view of the same environment, that is from robot sensors' point of view: the robot, in fact, does not know from the beginning the full map he's in, but thanks to the laser sensors and the <code>gmapping</code> package he is capable of creating it.</p>
<p><img src="https://github.com/claudio-dg/final_assignment/blob/main/images/Rviz.png?raw=true" alt="" width="400" class="inline"/> </p>
<h1><a class="anchor" id="autotoc_md3"></a>
Project structure and behaviour description</h1>
<p>The project is based on the ROS scheme that is shown in the following graph:</p>
<p><img src="https://github.com/claudio-dg/final_assignment/blob/main/images/final_assign_rosgraph.png?raw=true" alt="" width="900" class="inline"/> </p>
<p>The ROS package of the project is called <code>"final_assignment"</code>, it exploits two already given packages: <code>slam_gmapping</code>, which opens the environment and allows the robot to create a map of what sorrounds him, and <code>move_base</code>, which requires a goal to be sent to the topic <code>move_base/goal</code> in order to make the robot move towards it.</p>
<p>In addition to these i created two nodes contained in <code>src</code> folder named <code>InputConsole</code> and <code>controller</code>; as the name suggests the first one is encharged of taking user's inputs to select the desired behaviour of the robot, while the second one manages the consequences of user's request by communicating with other nodes, for instance by sending the goal's coordinates to <code>move_base/goal</code> with a msg of type :<code>move_base_msgs/MoveBaseActionGoal</code>. The communication between my two nodes is implemented through a <code>Publish/Subscribe</code> architecture using two different topics <code>MY_topic_teleop</code> &amp; <code>MY_topic_send_goal</code>: in this way I made a structure in which the input given by the user determines which callback is going to be called in the controller node, so that the "async structure" required by this assignment was possible.</p>
<ul>
<li>Regarding point 1) I used the <code>\move_base\feedback</code> topic to retreive information about robot's status such as the current position or the time counter: thanks to these two pieces of information I implemented an algorithm to state whether the goal was reached or not (considering an approximation error due to the fact that the robot seemed to get really close to the goal but never reaching its exact coordinates), and a TIMEOUT, so that if the robot doesen't reach the goal in Time it is considered unreachable and will be canceled by sending a msg to <code>\move_base\cancel</code> topic</li>
<li>Regarding points 2) and 3) of the assignment I remapped an already existing topic (<code>teleop_twist_keyboard</code>) so that instead of publishing directly on <code>cmd_vel</code> it publishes on my personal topic <code>myRemapped_cmd_vel</code>: by doing this I manage to consider the velocities published by this topic only when required, that is when the user selected mode 2) or 3), furthermore it allowed me to add the collision avoidance functionality needed for the third part of the assignment.</li>
</ul>
<h2><a class="anchor" id="autotoc_md4"></a>
Behaviour description  :</h2>
<p>After having launched all the required launch files Gazebo and Rviz environments will open, along with 3 different terminals:</p><ul>
<li><code>Input Console</code> : in which you can select what to do and that will show the following user interface: <div class="fragment"><div class="line">***********THIS IS THE INPUT CONSOLE***********</div>
<div class="line"> </div>
<div class="line">Which Action do you want to use to move the robot?</div>
<div class="line">ENTER &#39;c&#39; to cancel last given goal</div>
<div class="line">ENTER &#39;1&#39; to send a new goal to the robot</div>
<div class="line">ENTER &#39;2  to manually drive the robot</div>
<div class="line">ENTER &#39;3&#39; to manually drive the robot WITH assisted collision avoidance</div>
<div class="line">ENTER &#39;q&#39; to terminate this node</div>
</div><!-- fragment --></li>
<li><code>Controller Console</code> : that will show some useful real-time info depending on the modality selected in the input console, such as the elapsed time since the goal was given or some notifications to inform the user tha a certain direction will probably cause a collision.</li>
<li><code>TeleopTwist Keyboard Console</code> : in which the user can insert commands to manually drive the robot that will only be read if modality 2) or 3) were previously selected through the input console.</li>
</ul>
<h1><a class="anchor" id="autotoc_md5"></a>
Pseudocode</h1>
<p>To reproduce the behaviour previously described i wrote 2 C++ programms contained in the <code>src</code> folder:</p><ul>
<li>input_console.cpp</li>
<li><a class="el" href="controller_8cpp.html" title="Controller for the turtlesim.">controller.cpp</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md6"></a>
Input_console.cpp  :</h2>
<div class="fragment"><div class="line">initialize node</div>
<div class="line">initialize necessary publishers and subscribers</div>
<div class="line">Use continuous callback from clock topic</div>
<div class="line">    </div>
<div class="line">    print User Interface menu</div>
<div class="line">    wait for a keyboard input and put it into a variable &quot;input&quot;</div>
<div class="line">    switch(input)</div>
<div class="line">        case &#39;c&#39;:</div>
<div class="line">            publish on move_base/cancel topic to cancel last given goal</div>
<div class="line">        publish a flag msg on MY_topic_send_goal to reset variables in controller</div>
<div class="line">        print that goal has been canceled</div>
<div class="line">        break;</div>
<div class="line">        case &#39;1&#39;:</div>
<div class="line">        print autonomous driving introduction</div>
<div class="line">                ask for goal coordinates</div>
<div class="line">            read goal coordinates from the user</div>
<div class="line">                publish them on MY_topic_send_goal topic to notify the controller</div>
<div class="line">        print sent coordinates</div>
<div class="line">            break;</div>
<div class="line">        case &#39;2&#39;:</div>
<div class="line">            print manual driving introduction</div>
<div class="line">        print a message to tell the user to look at teleopkeyboard console</div>
<div class="line">        publish a boolean msg equal to 0 on MY_topic_teleop to inform the controller that manual driving was selected</div>
<div class="line">        break;           </div>
<div class="line">        case &#39;3&#39;:</div>
<div class="line">            print ASSISTED manual driving introduction</div>
<div class="line">        print a message to tell the user to look at teleopkeyboard console</div>
<div class="line">        publish a boolean msg equal to 1 on MY_topic_teleop to inform the controller that ASSISTED manual driving was selected</div>
<div class="line">        break;</div>
<div class="line">        case &#39;q&#39;:</div>
<div class="line">        print an exiting message</div>
<div class="line">        exit the program</div>
<div class="line">        default:</div>
<div class="line">            print an error for a wrong command inserted</div>
<div class="line">            break;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md7"></a>
Controller.cpp  :</h2>
<div class="fragment"><div class="line">initialize node</div>
<div class="line">initialize necessary publishers and subscribers</div>
<div class="line">print controller console introduction   </div>
<div class="line">    //the MAIN loops with ros::SpinOnce whilethe program isn&#39;t killed</div>
<div class="line">    //check for global flag values</div>
<div class="line">    </div>
<div class="line">    if user asked for manual drive</div>
<div class="line">        take velocity from teleopKeyboard contained into myRemapped_cmd_vel topic</div>
<div class="line">        publish it on cmd_vel topic to make the robot move</div>
<div class="line">    if user asked for ASSISTED manual drive</div>
<div class="line">        call assistedMovement function**</div>
<div class="line">    if user didn&#39;t ask for these 2 modalities, wait for other callbacks to be called</div>
<div class="line">    </div>
<div class="line">    //**assitedMovement function:</div>
<div class="line">        check distances received from laser sensors</div>
<div class="line">        if there is an obstacle in front of the robot</div>
<div class="line">            check for nearest obstacles at his sides</div>
<div class="line">            if nearest obstacle is at his right</div>
<div class="line">                turn left a bit</div>
<div class="line">                print feedback to the user</div>
<div class="line">            if nearest obstacle is at his left</div>
<div class="line">                turn right a bit</div>
<div class="line">                print feedback to the user</div>
<div class="line">            set flag changedVel to 1 to state that the direction has been modified</div>
<div class="line">            sleep 0.3 seconds</div>
<div class="line">        if the direction has been modified</div>
<div class="line">            stop the robot</div>
<div class="line">        else</div>
<div class="line">            clear the console</div>
<div class="line">            take velocity from teleopKeyboard contained into myRemapped_cmd_vel topic</div>
<div class="line">            publish it on cmd_vel topic to make the robot move</div>
<div class="line">    </div>
<div class="line">//basing on which msg is received from input cosole, different callbacks are executed</div>
<div class="line">    if &#39;c&#39; or &#39;1&#39; were inserted in input cosole  &quot;myCallback&quot; is executed</div>
<div class="line">        </div>
<div class="line">        reset manual drive global flag value</div>
<div class="line">        put goal coordinates in a global variable</div>
<div class="line">        if msg contains flag value for &quot;goal canceled&quot;</div>
<div class="line">            clear the terminal</div>
<div class="line">            print that goal has been canceled by user</div>
<div class="line">            set &quot;canceled&quot; global flag value to 1</div>
<div class="line">        else</div>
<div class="line">            reset global flags variables</div>
<div class="line">            publish goal on  move_base/goal topic</div>
<div class="line">            print that goal has been published</div>
<div class="line">    return</div>
<div class="line">    </div>
<div class="line">    if &#39;2&#39; or &#39;3&#39; were inserted in input cosole &quot;TeleopCallback&quot; is executed</div>
<div class="line">        </div>
<div class="line">        put msg&#39;s boolean value in the global flag variable &quot;manualdrive&quot;</div>
<div class="line">        cancel possibly existing goals</div>
<div class="line">        reset velocities to 0</div>
<div class="line">        if msg asked for manual drive</div>
<div class="line">            print manual driving introduction</div>
<div class="line">            print a message to tell the user to look at teleopkeyboard console</div>
<div class="line">        else if msg asked for ASSISTED manual drive</div>
<div class="line">            print ASSISTED manual driving introduction</div>
<div class="line">            print a message to tell the user to look at teleopkeyboard console</div>
<div class="line">    </div>
<div class="line">//last 2 callbacks (myCmdCallback &amp; CurrentPositionCallback) are called respectively when user inserts command on teleopKeyboard console and when the robot status changes</div>
<div class="line">    </div>
<div class="line">    //myCmdCallback</div>
<div class="line">    put the received vel in a global variable</div>
<div class="line">    reset changedVel flag each time a new command is inserted</div>
<div class="line">    </div>
<div class="line">    </div>
<div class="line">    //CurrentPositionCallback</div>
<div class="line">    execute the callback only if goal wasn&#39;t reached yet (goal_reached==0)</div>
<div class="line">    take current position coordinates from /move_base/feedback topic</div>
<div class="line">    if the status has changed just now (firstTime==1)</div>
<div class="line">        take current time as Starting time</div>
<div class="line">        reset firstTime flag value</div>
<div class="line">    keep updating current time</div>
<div class="line">    compute elapsed time since the goal was given</div>
<div class="line">    print info about goal coordinates and time elapsed</div>
<div class="line">    compute Error between current position and Goal position</div>
<div class="line">    if error is small enough</div>
<div class="line">        set goal_reached flag to TRUE</div>
<div class="line">    if the timeout is over and the goal hasn&#39;t been reached</div>
<div class="line">        cancel the goal </div>
<div class="line">        print that goal has been canceled</div>
<div class="line">    else if  goal has been reached before timeout was over</div>
<div class="line">        clear console</div>
<div class="line">        print that goal was reached</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
